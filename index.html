<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIM Elite - 675B Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root { --bg: #0b0f1a; --card: #161e2e; --text: #f1f5f9; --accent: #38bdf8; --green: #4ade80; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding: 10px; }
        .section { background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 12px; border: 1px solid #2d3748; }
        
        /* GAUGE & STATS */
        .gauge-wrap { display: flex; align-items: center; gap: 10px; }
        .bar { flex-grow: 1; height: 8px; background: #1f2937; border-radius: 4px; overflow: hidden; }
        #needle { height: 100%; width: 0%; background: var(--accent); transition: 0.3s ease; }
        .ms-val { font-family: monospace; color: var(--accent); font-weight: bold; font-size: 1em; }

        /* CHAT BOX */
        .msgs { height: 450px; overflow-y: auto; padding: 15px; background: #0b0f1a; border-radius: 8px; border: 1px solid #2d3748; margin: 10px 0; }
        .msg { margin-bottom: 20px; line-height: 1.6; position: relative; padding-top: 15px; border-bottom: 1px solid #1e293b; padding-bottom: 10px; }
        .tag { position: absolute; top: 0; right: 0; font-size: 0.7em; color: var(--green); font-weight: bold; }

        /* MARKDOWN SPECIFIC */
        .msg-content code { background: #1e293b; color: #f87171; padding: 2px 5px; border-radius: 4px; font-family: monospace; font-size: 0.9em; }
        .msg-content pre { background: #000; padding: 12px; border-radius: 8px; overflow-x: auto; margin: 10px 0; border: 1px solid #334155; position: relative; }
        .msg-content pre code { background: none; color: #fff; padding: 0; }
        .msg-content h3 { color: var(--accent); margin-top: 10px; }
        .msg-content blockquote { border-left: 3px solid var(--accent); padding-left: 10px; color: #94a3b8; font-style: italic; }

        /* BUTTONS */
        button { background: var(--accent); color: #0b0f1a; border: none; padding: 10px 15px; border-radius: 6px; font-weight: bold; cursor: pointer; }
        textarea { width: 100%; background: #0b0f1a; border: 1px solid #2d3748; color: white; padding: 12px; border-radius: 6px; font-size: 16px; height: 55px; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; margin-top: 10px; }
        .m-card { background: #1e293b; border: 1px solid #334155; padding: 10px; border-radius: 8px; font-size: 0.7em; text-align: center; cursor: pointer; }
        .size-badge { font-weight: 800; color: var(--accent); display: block; margin-bottom: 2px; }
    </style>
</head>
<body>

<div class="section">
    <div class="gauge-wrap">
        <div class="ms-val" id="ms-text">0 ms</div>
        <div class="bar"><div id="needle"></div></div>
        <button onclick="document.documentElement.classList.toggle('dark-mode')" style="padding:2px 8px;">ðŸŒ“</button>
    </div>
</div>

<div class="section" id="chat-ui">
    <select id="mod-select" style="width:100%; background:#0b0f1a; color:white; padding:8px; border-radius:6px; margin-bottom:10px;"></select>
    <div class="msgs" id="chat-box"></div>
    <div style="display:flex; gap:8px;">
        <textarea id="user-input" placeholder="Enter prompt..."></textarea>
        <button onclick="send()">SEND</button>
    </div>
</div>

<div class="section">
    <input type="text" id="api-url" placeholder="Proxy URL" style="margin-bottom:8px;">
    <div style="display:flex; gap:8px;">
        <button onclick="getModels()">ðŸ¤– Load NIMs</button>
        <button onclick="stressTest()" style="background:#f87171;">ðŸ”¥ Stress</button>
    </div>
    <div id="model-grid" class="grid"></div>
</div>

<script>
    let logs = [];
    const getBase = () => { let u = document.getElementById('api-url').value.replace(/\/$/, ''); localStorage.setItem('nim_v4', u); return u; };
    window.onload = () => { let saved = localStorage.getItem('nim_v4'); if(saved) { document.getElementById('api-url').value = saved; getModels(); } };

    async function getModels() {
        try {
            const r = await fetch(`${getBase()}/v1/models`);
            const d = await r.json();
            const parseB = (id) => {
                const match = id.match(/(\d+(\.\d+)?)[bm]/i);
                if (!match) return 0;
                return id.toLowerCase().includes('b') ? parseFloat(match[1]) : parseFloat(match[1]) / 1000;
            };
            const sorted = d.data.sort((a, b) => parseB(b.id) - parseB(a.id));
            document.getElementById('mod-select').innerHTML = sorted.map(m => `<option value="${m.id}">${m.id}</option>`).join('');
            document.getElementById('model-grid').innerHTML = sorted.map(m => {
                const size = m.id.match(/(\d+[bm])/i);
                return `<div class="m-card" onclick="document.getElementById('mod-select').value='${m.id}'">
                    <span class="size-badge">${size ? size[0].toUpperCase() : '---'}</span>
                    ${m.id.split('/').pop().replace(/-instruct|-it/g, '')}
                </div>`;
            }).join('');
        } catch(e) { console.log("Fetch failed"); }
    }

    function setGauge(ms) {
        document.getElementById('ms-text').innerText = ms + " ms";
        let width = Math.max(5, Math.min(100, 100 - (ms / 15)));
        document.getElementById('needle').style.width = width + "%";
    }

    async function send() {
        const b = getBase(); const m = document.getElementById('mod-select').value; const i = document.getElementById('user-input');
        if(!i.value || !m) return;
        logs.push({role:'user', content: i.value});
        let ai = {role:'assistant', content: '', lat: 0};
        logs.push(ai); i.value = ''; render();
        const t0 = Date.now();
        try {
            const res = await fetch(`${b}/v1/chat/completions`, {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ model: m, messages: logs.slice(0,-1), stream: true, max_tokens: 2000 })
            });
            const reader = res.body.getReader();
            const decoder = new TextDecoder();
            while (true) {
                const {done, value} = await reader.read();
                if (done) break;
                const lines = decoder.decode(value).split('\n');
                for (let l of lines) {
                    if (l.startsWith('data: ') && l !== 'data: [DONE]') {
                        try {
                            const json = JSON.parse(l.substring(6));
                            const text = json.choices[0].delta.content;
                            if (text) {
                                if (!ai.lat) { ai.lat = Date.now() - t0; setGauge(ai.lat); }
                                ai.content += text;
                                render();
                            }
                        } catch (e) {}
                    }
                }
            }
        } catch(e) { ai.content += "\n[Error]"; render(); }
    }

    async function stressTest() {
        const b = getBase(); const m = document.getElementById('mod-select').value;
        logs.push({role:'system', content: `ðŸ”¥ BURST: Testing ${m}`}); render();
        const s = Date.now();
        await Promise.all(Array.from({length:5}).map(() => 
            fetch(`${b}/v1/chat/completions`, {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({model:m, messages:[{role:'user', content:'hi'}], max_tokens:10})
            })
        ));
        const avg = Math.round((Date.now() - s) / 5);
        logs.push({role:'system', content: `âœ… AVG LATENCY: ${avg}ms`});
        setGauge(avg); render();
    }

    function render() {
        const box = document.getElementById('chat-box');
        box.innerHTML = logs.map(l => {
            const content = l.role === 'system' ? l.content : marked.parse(l.content);
            return `
            <div class="msg">
                <span class="tag">${l.lat ? l.lat+'ms' : ''}</span>
                <b style="color:var(--accent)">${l.role.toUpperCase()}</b>
                <div class="msg-content">${content}</div>
            </div>`;
        }).join('');
        box.scrollTop = box.scrollHeight;
    }
</script>
</body>
</html>
